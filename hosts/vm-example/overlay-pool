# this pool overlay is only active if set in configuration.sh AND file exists.
zpool_create() {
    # convert option from nix true/false style to proper zfs on/off option format.
    if [[ $zfs_use_atime == "true" ]] ; then zfs_use_atime="on" ; else zfs_use_atime="off" ; fi

    # join the disk array items together into one variable, separated by spaces. (used by zpool_create())
    # but first append the partition number, if there is one to append (in the case of uefi)
    zfs_pool_disks_joined=( "${zfs_pool_disks[@]/%/$zpool_partition}" )
    join_by() { local IFS="$1"; shift; echo "$*"; }
    zfs_pool_create_disks=$(join_by ' ' "${zfs_pool_disks_joined[@]}")

    echo "creating zpool..."
    zpool create -f \
          -o ashift=12 \
          -O compression=lz4 \
          -O atime=$zfs_use_atime \
          -O relatime=on \
          -O normalization=formD \
          -O xattr=sa \
          -m none \
          -R /mnt \
          $zfs_pool_name \
          $zfs_pool_type \
          $zfs_pool_create_disks || fail_warning

    # https://github.com/NixOS/nixpkgs/issues/16954
    zfs set acltype=posixacl "$zfs_pool_name"
}
zpool_create
